openapi: 3.0.3
info:
  title: API Distribuidora Torres
  version: 1.0.0
  description: Backend de catálogo, auth, carrito, direcciones y órdenes.
servers:
  - url: http://localhost:3000
    description: Local

tags:
  - name: Auth
  - name: Catálogo
  - name: Carrito
  - name: Direcciones
  - name: Órdenes
  - name: Admin
  - name: Bolsas

paths:
  /api/health:
    get:
      summary: Healthcheck
      tags: [Auth]
      responses:
        '200': { description: OK }

  /api/auth/register:
    post:
      summary: Registrar usuario
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterReq' }
      responses:
        '201':
          description: Usuario creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '409': { description: Correo ya registrado }

  /api/auth/login:
    post:
      summary: Login
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginReq' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
                  token:
                    type: string
                    description: JWT
        '401': { description: Credenciales inválidas }

  /api/auth/olvido-contrasena:
    post:
      tags: [Auth]
      summary: Solicitar restablecimiento de contraseña
      description: |
        Envía un correo con un enlace para restablecer la contraseña.
        Por seguridad, siempre devuelve OK aunque el correo no exista.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [correo]
              properties:
                correo:
                  type: string
                  format: email
                  example: isaac.th2005@gmail.com
      responses:
        '200':
          description: Solicitud procesada
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /api/auth/restablecer-contrasena:
    post:
      tags: [Auth]
      summary: Restablecer contraseña
      description: |
        Restablece la contraseña usando un token válido.
        El token debe ser de un solo uso y no expirado.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, contrasena]
              properties:
                token:
                  type: string
                  example: 3fa85f64b3e24c0fa4ccecbf9d...
                contrasena:
                  type: string
                  format: password
                  example: NuevaClave123
      responses:
        '200':
          description: Contraseña restablecida correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
        '400':
          description: Token inválido, usado o expirado


  /api/tipos-bolsas:
    get:
      summary: Listar tipos de bolsa (público)
      tags: [Catálogo]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/TipoBolsa' }

  /api/tipos-bolsas/{id}/subtipos:
    get:
      summary: Listar subtipos por tipo (público)
      tags: [Catálogo]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/SubtipoBolsa' }
        '404': { description: Tipo no encontrado }

  /api/bolsas:
    get:
      summary: Listar bolsas (público)
      tags: [Catálogo]
      parameters:
        - in: query
          name: tipo
          schema: { type: integer, minimum: 1 }
        - in: query
          name: subtipo
          schema: { type: integer, minimum: 1 }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 12 }
        - in: query
          name: sort
          schema:
            type: string
            enum: [ancho_asc, ancho_desc, alto_asc, alto_desc]
        - in: query
          name: meta
          schema: { type: boolean, default: true }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Paged'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/Bolsa' }

  /api/subtipos/{id_subtipo}/imagenes:
    get:
      summary: Imágenes públicas por subtipo
      tags: [Catálogo]
      parameters:
        - in: path
          name: id_subtipo
          required: true
          schema: { type: integer, minimum: 1 }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, default: 50 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Paged'
                  - type: object
                    properties:
                      data:
                        type: array
                        items: { $ref: '#/components/schemas/ImagenSubtipo' }
        '404': { description: Subtipo no encontrado }

  /api/cart:
    get:
      summary: Ver carrito activo
      tags: [Carrito]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Carrito' }
        '401': { description: No autenticado }
    delete:
      summary: Vaciar carrito
      tags: [Carrito]
      security: [{ bearerAuth: [] }]
      responses:
        '204': { description: Vaciado }
        '401': { description: No autenticado }

  /api/cart/items:
    post:
      summary: Agregar (o sumar) ítem al carrito
      description: >
        Para ventas **por kg**, `cantidad` acepta decimales con step **0.25** (mínimo 0.25).  
        Para **packs** o **unidad**, `cantidad` debe ser entero.
      tags: [Carrito]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id_bolsa, cantidad]
              properties:
                id_bolsa: { type: integer, minimum: 1 }
                cantidad:
                  type: number
                  minimum: 0.25
                  multipleOf: 0.25
                  description: |
                    Por kg: múltiplos de 0.25 (0.25, 0.5, 0.75, ...).
                    Por pack o unidad: usar enteros (1, 2, 3...).
      responses:
        '201': { description: Agregado }
        '400': { description: Solicitud inválida }
        '401': { description: No autenticado }

  /api/cart/items/{id_bolsa}:
    patch:
      summary: Cambiar cantidad exacta
      description: >
        Para ventas **por kg**, `cantidad` acepta decimales con step **0.25** (mínimo 0.25).  
        Para **packs** o **unidad**, `cantidad` debe ser entero.
      tags: [Carrito]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id_bolsa
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [cantidad]
              properties:
                cantidad:
                  type: number
                  minimum: 0.25
                  multipleOf: 0.25
                  description: |
                    Por kg: múltiplos de 0.25 (0.25, 0.5, 0.75, ...).
                    Por pack o unidad: usar enteros (1, 2, 3...).
      responses:
        '200': { description: Actualizado }
        '401': { description: No autenticado }
        '404': { description: Ítem no encontrado }
    delete:
      summary: Eliminar ítem del carrito
      tags: [Carrito]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id_bolsa
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '204': { description: Eliminado }
        '401': { description: No autenticado }

  /api/direcciones:
    get:
      summary: Listar mis direcciones
      tags: [Direcciones]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Direccion' }
        '401': { description: No autenticado }
    post:
      summary: Crear dirección
      tags: [Direcciones]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DireccionReq' }
      responses:
        '201': { description: Creada }
        '401': { description: No autenticado }

  /api/direcciones/{id}:
    get:
      summary: Obtener una dirección
      tags: [Direcciones]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Direccion' }
        '401': { description: No autenticado }
        '404': { description: No encontrada }
    put:
      summary: Actualizar dirección
      tags: [Direcciones]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DireccionReq' }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '404': { description: No encontrada }
    delete:
      summary: Eliminar dirección
      tags: [Direcciones]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '204': { description: Eliminada }
        '401': { description: No autenticado }
        '404': { description: No encontrada }

  /api/orders/checkout:
    post:
      summary: Crear orden desde carrito
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutRequest'
            examples:
            retiro-efectivo:
              value: { id_direccion: null, id_metodo_pago: 1, id_tipo_entrega: 1 }
            envio-sinpe:
              value: { id_direccion: 12, id_metodo_pago: 2, id_tipo_entrega: 2, notas: "Entregar antes de las 5pm", codigo_descuento: "BIENVENIDO10" }

      responses:
        '201':
          description: Orden creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
        '400':
          description: Carrito vacío o datos inválidos
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Error interno
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /api/orders/checkout/preview:
    get:
      summary: Preview del checkout (carrito + totales + direcciones + catálogos)
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Snapshot para renderizar el checkout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutPreviewResponse'
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Error interno
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /api/orders:
    get:
      summary: Mis órdenes (resumen)
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/OrdenResumen' }
        '401': { description: No autenticado }

  /api/orders/{id}:
    get:
      summary: Detalle de mi orden
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Orden' }
        '401': { description: No autenticado }
        '404': { description: No encontrada }

  /api/orders/{id}/comprobantes:
    post:
      summary: Subir comprobante de pago (cliente)
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                archivo:
                  type: string
                  format: binary
                  description: Imagen o PDF (máx 10 MB)
              required: [archivo]
      responses:
        '201':
          description: Comprobante subido
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UploadComprobanteResponse' }
        '400': { description: Datos inválidos }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Orden no encontrada }
        '500': { description: Error interno }

    get:
      summary: Listar mis comprobantes de una orden (cliente)
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Comprobante' }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Orden no encontrada }
        '500': { description: Error interno }

  /api/orders/comprobantes/{id}:
    patch:
      summary: Aprobar o rechazar comprobante (admin)
      tags: [Órdenes]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatchComprobanteRequest' }
            examples:
              aprobar:
                value: { estado: "aprobado", notas: "Depósito verificado" }
              rechazar:
                value: { estado: "rechazado", notas: "Monto insuficiente" }
      responses:
        '200': { description: OK }
        '400': { description: Estado inválido }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: No encontrado }
        '500': { description: Error interno }


  /api/admin/orders:
    get:
      summary: Listado admin con filtros/paginación
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: estado
          schema: { type: string, description: "Nombre o id" }
        - in: query
          name: usuario
          schema: { type: integer, minimum: 1 }
        - in: query
          name: fechaDesde
          schema: { type: string, format: date-time }
        - in: query
          name: fechaHasta
          schema: { type: string, format: date-time }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, default: 20 }
        - in: query
          name: sort
          schema: { type: string, enum: [fecha_asc, fecha_desc, total_asc, total_desc], default: fecha_desc }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        

  /api/admin/orders/{id}/status:
    patch:
      summary: Cambiar estado de orden (por id_estado)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id_estado]
              properties:
                id_estado: { type: integer, minimum: 1 }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Orden no encontrada }

  /api/admin/subtipos/{id_subtipo}/imagenes:
    get:
      summary: Listar imágenes de un subtipo (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id_subtipo
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/ImagenSubtipo' }
        '401': { description: No autenticado }
        '403': { description: No autorizado }

    post:
      summary: Crear imagen por URL (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id_subtipo
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url_imagen]
              properties:
                url_imagen: { type: string, format: uri }
                descripcion: { type: string, maxLength: 255 }
                orden: { type: integer, minimum: 1 }
      responses:
        '201': { description: Creada }
        '401': { description: No autenticado }
        '403': { description: No autorizado }

  /api/admin/subtipos/{id_subtipo}/imagenes/upload:
    post:
      summary: Subir imagen (archivo) al subtipo (admin)
      description: Sube una imagen mediante multipart/form-data.
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id_subtipo
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                descripcion:
                  type: string
                orden:
                  type: integer
      responses:
        '201': { description: Imagen subida }
        '400': { description: Archivo inválido }
        '401': { description: No autenticado }
        '403': { description: No autorizado }

  /api/admin/imagenes/{id}:
    put:
      summary: A
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url_imagen: { type: string, format: uri }
                descripcion: { type: string, maxLength: 255 }
                orden: { type: integer, minimum: 1 }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Imagen no encontrada }
    delete:
      summary: Eliminar imagen (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '204': { description: Eliminada }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: Imagen no encontrada }

  /api/users/me:
    put:
      summary: Editar mi perfil
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nombre: { type: string }
                primer_apellido: { type: string }
                segundo_apellido: { type: string }
                correo: { type: string, format: email }
                negocio: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: No autenticado }
        '409': { description: Correo ya registrado }

  /api/users/me/password:
    patch:
      summary: Cambiar mi contraseña
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [contrasena_actual, contrasena_nueva]
              properties:
                contrasena_actual: { type: string, minLength: 8 }
                contrasena_nueva:  { type: string, minLength: 8 }
      responses:
        '204': { description: Actualizada }
        '400': { description: Datos inválidos }
        '401': { description: No autenticado / actual incorrecta }

  /api/admin/users:
    get:
      summary: Listar usuarios (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: correo
          schema: { type: string }
        - in: query
          name: rol
          schema: { type: integer, minimum: 1 }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '403': { description: No autorizado }

  /api/admin/users/{id}:
    get:
      summary: Obtener usuario por id (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: No encontrado }

    put:
      summary: Actualizar usuario (admin)
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nombre: { type: string }
                primer_apellido: { type: string }
                segundo_apellido: { type: string }
                correo: { type: string, format: email }
                id_rol_usuario: { type: integer }
      responses:
        '200': { description: OK }
        '401': { description: No autenticado }
        '403': { description: No autorizado }
        '404': { description: No encontrado }
        '409': { description: Correo ya registrado }

  /api/bolsas/{id}/pricing:
    get:
      tags: [Bolsas]
      summary: Resuelve la estrategia y precio vigente para una bolsa
      description: >
        Devuelve la estrategia de pricing aplicable al SKU indicado, resolviendo en este orden:
        **id_bolsa > id_subtipo_bolsa > id_tipo_bolsa** y respetando prioridad/fechas de vigencia.
        Soporta `por_kg` (con o sin `es_peso_variable`), `por_pack` y `por_unidad`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: ID de la bolsa (SKU)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PricingPorKg'
                  - $ref: '#/components/schemas/PricingPorPack'
                  - $ref: '#/components/schemas/PricingPorUnidad'
        '400':
          description: Solicitud inválida
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Bolsa o regla no encontrada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Error interno
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id_usuario: { type: integer }
        id_rol_usuario: { type: integer }
        nombre: { type: string }
        primer_apellido: { type: string }
        segundo_apellido: { type: string }
        correo: { type: string, format: email }
        negocio: { type: string }
        fecha_registro: { type: string, format: date-time }

    RegisterReq:
      type: object
      required: [correo, contrasena]
      properties:
        correo: { type: string, format: email }
        contrasena: { type: string, minLength: 8 }
        nombre: { type: string }
        primer_apellido: { type: string }
        segundo_apellido: { type: string }
        id_rol_usuario: { type: integer }

    LoginReq:
      type: object
      required: [correo, contrasena]
      properties:
        correo: { type: string, format: email }
        contrasena: { type: string }

    TipoBolsa:
      type: object
      properties:
        id_tipo_bolsa: { type: integer }
        nombre_bolsa: { type: string }

    SubtipoBolsa:
      type: object
      properties:
        id_subtipo_bolsa: { type: integer }
        id_tipo_bolsa: { type: integer }
        nombre_subtipo_bolsa: { type: string }
        descripcion_subtipo: { type: string }

    ImagenSubtipo:
      type: object
      properties:
        id_imagen: { type: integer }
        id_subtipo_bolsa: { type: integer }
        url_imagen: { type: string, format: uri }
        descripcion: { type: string }
        orden: { type: integer }

    Bolsa:
      type: object
      properties:
        id_bolsa: { type: integer }
        id_tipo_bolsa: { type: integer }
        id_subtipo_bolsa: { type: integer }
        ancho: { type: number }
        alto: { type: number }
        precio:
          type: number
          format: float
          nullable: true
          deprecated: true
          description: "DEPRECADO: los precios viven en pricing_regla"
        descripcion_bolsa: { type: string }
        es_peso_variable:
          type: boolean
          description: "TRUE solo para rollos; el resto FALSE"

    DireccionReq:
      type: object
      required: [direccion_exacta, provincia, canton, distrito]
      properties:
        direccion_exacta: { type: string }
        distrito: { type: string }
        canton: { type: string }
        provincia: { type: string }
        codigo_postal: { type: integer }
        activa: { type: boolean }

    Direccion:
      allOf:
        - $ref: '#/components/schemas/DireccionReq'
        - type: object
          properties:
            id_direccion: { type: integer }
            fecha_registro: { type: string, format: date-time }

    CarritoItem:
      type: object
      properties:
        bolsa: { $ref: '#/components/schemas/Bolsa' }
        cantidad:
          type: number
          minimum: 0.25
          multipleOf: 0.25
          description: |
            Por kg: múltiplos de 0.25. Por pack/unidad: usar enteros.
        precio_unitario: { type: number, format: float }

    Carrito:
      type: object
      properties:
        id_carrito: { type: integer }
        items:
          type: array
          items: { $ref: '#/components/schemas/CarritoItem' }
        subtotal: { type: number, format: float }
        total: { type: number, format: float }

    OrdenResumen:
    type: object
    properties:
      id_orden:    { type: integer }
      fecha:       { type: string, format: date-time }
      gran_total:  { type: number, format: float, nullable: true }
      estado:
        type: object
        properties:
          id:     { type: integer }
          nombre: { type: string }
      tipo_entrega: { type: string, nullable: true }
      metodo_pago:  { type: string, nullable: true }


    Orden:
    type: object
    properties:
      id_orden: { type: integer }
      fecha:    { type: string, format: date-time }
      estado:
        type: object
        properties:
          id:     { type: integer }
          nombre: { type: string }
      totales:
        type: object
        properties:
          subtotal_est_max: { type: number, format: float, nullable: true }
          subtotal_final:   { type: number, format: float, nullable: true }
          descuento_total:  { type: number, format: float }
          envio_total:      { type: number, format: float }
          impuesto_total:   { type: number, format: float }
          gran_total:       { type: number, format: float, nullable: true }
      flags:
        type: object
        properties:
          tiene_peso_variable: { type: boolean }
      pesos:
        type: object
        properties:
          max_total_kg:  { type: number, format: float, nullable: true }
          real_total_kg: { type: number, format: float, nullable: true }
      descuento:
        type: object
        properties:
          codigo: { type: string, nullable: true }
      entrega:
        type: object
        properties:
          id:     { type: integer, nullable: true }
          nombre: { type: string, nullable: true }
      pago:
        type: object
        properties:
          id:     { type: integer, nullable: true }
          nombre: { type: string, nullable: true }
      direccion:
        type: object
        nullable: true
        properties:
          id:               { type: integer, nullable: true }
          direccion_exacta: { type: string, nullable: true }
          distrito:         { type: string, nullable: true }
          canton:           { type: string, nullable: true }
          provincia:        { type: string, nullable: true }
          codigo_postal:    { type: string, nullable: true }
      items:
        type: array
        items:
          type: object
          properties:
            id_bolsa:          { type: integer }
            descripcion_bolsa: { type: string }
            dimensiones:
              type: object
              properties:
                ancho: { type: number, format: float, nullable: true }
                alto:  { type: number, format: float, nullable: true }
            precio_unitario: { type: number, format: float, nullable: true }
            cantidad:        { type: integer }
            subtotal:        { type: number, format: float, nullable: true }


    Paged:
      type: object
      properties:
        page: { type: integer }
        pageSize: { type: integer }
        total: { type: integer }

    # --- Pricing ---
    PricingBase:
      type: object
      required: [estrategia, moneda]
      properties:
        estrategia:
          type: string
          enum: [por_kg, por_pack, por_unidad]
        moneda:
          type: string
          example: CRC

    PricingPorKg:
      allOf:
        - $ref: '#/components/schemas/PricingBase'
        - type: object
          required: [precio_por_kg, es_peso_variable]
          properties:
            precio_por_kg:
              type: number
              format: float
              example: 1800
            es_peso_variable:
              type: boolean
              description: true para rollos; false para ventas por kg normales
              example: false
            peso_max_kg:
              type: number
              format: float
              nullable: true
              description: Tope por rollo (solo si es_peso_variable=true)
              example: 2.3

    PricingPorPack:
      allOf:
        - $ref: '#/components/schemas/PricingBase'
        - type: object
          required: [packs]
          properties:
            packs:
              type: array
              minItems: 1
              items: { $ref: '#/components/schemas/PackOption' }

    PackOption:
      type: object
      required: [pack_qty, precio_por_pack]
      properties:
        pack_qty:
          type: integer
          example: 24
        precio_por_pack:
          type: number
          format: float
          example: 3600

    PricingPorUnidad:
      allOf:
        - $ref: '#/components/schemas/PricingBase'
        - type: object
          required: [precio_por_unidad]
          properties:
            precio_por_unidad:
              type: number
              format: float
              example: 75

    # === Errores JSON unificados ===
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          example: "No se pudo crear la orden"
        detail:
          type: string
          nullable: true
          example: "column «costo» does not exist"
        code:
          type: string
          nullable: true
          example: "42703"
        where:
          type: string
          nullable: true
          example: "orders:checkout"
        table:
          type: string
          nullable: true
        column:
          type: string
          nullable: true
        constraint:
          type: string
          nullable: true
        hint:
          type: string
          nullable: true

    # === Checkout: request/response ===
    CheckoutRequest:
    type: object
    required: [id_tipo_entrega]
    properties:
      id_direccion:   { type: integer, nullable: true, description: ID de la dirección seleccionada (nulo si retiro) }
      id_metodo_pago: { type: integer, nullable: true, description: Efectivo, SINPE, etc. }
      id_tipo_entrega:{ type: integer, description: Retiro/Envío/Ruta... }
      codigo_descuento:
        type: string
        nullable: true
        description: Código de cupón a aplicar (el monto se resolverá con tabla de cupones)
      notas:
        type: string
        nullable: true
        description: Notas del cliente para la entrega


    CheckoutResponse:
    type: object
    properties:
      id_orden: { type: integer }
      totales:
        type: object
        properties:
          subtotal_est_max: { type: number, format: float, nullable: true }
          subtotal_final:   { type: number, format: float, nullable: true }
          descuento_total:  { type: number, format: float }
          envio_total:      { type: number, format: float }
          impuesto_total:   { type: number, format: float }
          gran_total:       { type: number, format: float, nullable: true }

    # === Preview payload ===
    CheckoutPreviewResponse:
    type: object
    properties:
      items:
        type: array
        items:
          type: object
          properties:
            id_bolsa:        { type: integer }
            cantidad:        { type: integer }
            precio_unitario: { type: number, format: float }
            subtotal_item:   { type: number, format: float }
            producto:        { type: string }
            ancho:           { type: number, format: float, nullable: true }
            alto:            { type: number, format: float, nullable: true }
            es_peso_variable:{ type: boolean }
            imagen_url:      { type: string, nullable: true }
      totals:
        type: object
        properties:
          subtotal: { type: number, format: float }
          shipping: { type: number, format: float }
          taxes:    { type: number, format: float }
          total:    { type: number, format: float }
      addresses:
        type: array
        items:
          type: object
          properties:
            id_direccion:     { type: integer }
            provincia:        { type: string, nullable: true }
            canton:           { type: string, nullable: true }
            distrito:         { type: string, nullable: true }
            direccion_exacta: { type: string, nullable: true }
            codigo_postal:    { type: string, nullable: true }
            label:            { type: string }
      payment_methods:
        type: array
        items:
          type: object
          properties:
            id_metodo_pago: { type: integer }
            nombre:         { type: string }
            descripcion:    { type: string, nullable: true }
            slug:           { type: string }
      delivery_types:
        type: array
        items:
          type: object
          properties:
            id_tipo_entrega: { type: integer }
            nombre:          { type: string }
            slug:            { type: string }
            costo:           { type: number, format: float }


    PreviewItem:
      type: object
      properties:
        id_bolsa: { type: integer }
        producto: { type: string, description: "descripcion_bolsa u otro nombre legible" }
        cantidad: { type: number }
        precio_unitario: { type: number, format: float, nullable: true }
        subtotal_item: { type: number, format: float }
        ancho: { type: number, format: float, nullable: true }
        alto:  { type: number, format: float, nullable: true }
        imagen_url: { type: string, format: uri, nullable: true }
        es_peso_variable: { type: boolean, nullable: true }

    Totals:
      type: object
      properties:
        subtotal: { type: number, format: float }
        shipping: { type: number, format: float }
        taxes:    { type: number, format: float }
        total:    { type: number, format: float }

    CheckoutAddress:
      allOf:
        - $ref: '#/components/schemas/Direccion'
        - type: object
          properties:
            label:
              type: string
              description: Texto legible para mostrar en el select (provincia/cantón/distrito · dirección_exacta)

    PaymentMethod:
      type: object
      properties:
        id_metodo_pago: { type: integer }
        nombre:         { type: string }
        descripcion:    { type: string, nullable: true }
        slug:
          type: string
          description: Normalizado por backend
          enum: [efectivo, sinpe, tarjeta, pendiente]

    DeliveryType:
      type: object
      properties:
        id_tipo_entrega: { type: integer }
        nombre:          { type: string }
        slug:
          type: string
          enum: [retiro, envio, ruta]
        costo:
          type: number
          format: float

    Comprobante:
    type: object
    properties:
      id_comprobante: { type: integer }
      id_orden:       { type: integer }
      url_archivo:    { type: string, format: uri }
      tipo_mime:      { type: string }
      nombre_archivo: { type: string }
      tamano_bytes:   { type: integer, nullable: true }
      estado:         { type: string, enum: [pendiente, aprobado, rechazado] }
      notas:          { type: string, nullable: true }
      subido_por:     { type: integer, nullable: true }
      subido_en:      { type: string, format: date-time }
      validado_por:   { type: integer, nullable: true }
      validado_en:    { type: string, format: date-time, nullable: true }

    UploadComprobanteResponse:
      $ref: '#/components/schemas/Comprobante'

    PatchComprobanteRequest:
      type: object
      required: [estado]
      properties:
        estado: { type: string, enum: [aprobado, rechazado] }
        notas:  { type: string, nullable: true }

